layui.use(['form', 'layer'], function () {
    var layer = layui.layer;
    var form = layui.form;
    // 阻止刷新
    $(function () {
        $('.get-login,.login-btn,.personalData-tips-but').off().on("click", function (e) {
            e.preventDefault();
        });
    });
    form.on('submit(intelligentSchoolSelection)', function (data) {
        if (!data.field.userId) {
            layer.msg('请先登录', {icon: 2}, function () {
                open('http://www.eskedu.com/dl/')
            })
            return false;
        }
        $.ajax({
            url: '/index/Iss/intelligentSchoolSelection.html',
            data: data.field,
            type: 'post',
            dataType: 'json',
            async: false,
            success: function (res) {
                if (res.code === 200) {
                    layer.msg(res.message, {icon: 1}, function () {
                        window.location.href = res.url;
                    })
                } else {
                    layer.msg(res.message, {icon: 2});
                }
            }, error: function () {
                layer.msg('接口错误')
            }
        });
        return false;
    });
    $(".year").click(function () {
        $("#year").val($(this).data('id'));
        jumpLink(form.val("school"))
    });
    $(".country").click(function () {
        $("#country").val($(this).data('id'))
        jumpLink(form.val("school"))
    });
    $(".rankingByCategory").click(function () {
        $("#rankingByCategory").val($(this).data('id'))
        jumpLink(form.val("school"))
    });
    $(".nowRankingByCategory").click(function () {
        $("#nowRankingByCategory").val($(this).data('id'))
        jumpLink(form.val("school"))
    });
    $(".subject-year").click(function () {
        $("#year").val($(this).data('id'));
        jumpLink(form.val("subject"))
    });
    $(".subject-subject").click(function () {
        $("#subject").val($(this).data('id'));
        jumpLink(form.val("subject"))
    });
    $(".subject-major").click(function () {
        $("#major").val($(this).data('id'));
        jumpLink(form.val("subject"))
    });
    $(".subject-inclination").click(function () {
        $("#inclination").val($(this).data('id'));
        jumpLink(form.val("subject"))
    });

    function jumpLink(data) {
        window.location.href = getUrl(window.location.protocol + '//' + window.location.host + window.location.pathname, data)
    }

    // 拼合url链接
    function getUrl(url, data) {
        //看原始url地址中开头是否带?，然后拼接处理好的参数
        return url += (url.indexOf('?') < 0 ? '?' : '') + getParam(data)
    }

    function getParam(data) {
        let url = '';
        for (var k in data) {
            let value = data[k] !== undefined ? data[k] : '';
            url += `&${k}=${encodeURIComponent(value)}`
        }
        return url ? url.substring(1) : ''
    }
});

//发送验证码
function phoneCode(type) {
    var count = 60;
    var phone = $(".update-tel").val(); //手机号码
    var reg = /^1[3|4|5|7|8][0-9]\d{4,8}$/;
    if (!reg.exec(phone) || phone == null || phone == '') {
        layer.msg("手机号格式错误")
        return false;
    } else {
        $.ajax({
            type: 'post',
            data: {'type': type, 'phone': phone},
            url: '/sendCode',
            dataType: 'json',
            async: false,
            success: function (res) {
                if (res.code == 200) {
                    $(".update-send").attr('disabled', 'disabled');
                    $('.update-send').css("background", "rgba(248,248,248,1)");
                    $('.update-send').css("border", "1px solid rgba(194,194,194,1)");
                    $('.update-send').css("color", "#999");
                    $(".update-send").val("倒计时" + count + "秒");
                    var timer = setInterval(function () {
                        count--;
                        $(".update-send").attr('disabled', 'disabled');
                        $(".update-send").val("倒计时" + count + "秒");
                        if (count == 0) {
                            clearInterval(timer);
                            $(".update-send").removeAttr("disabled");
                            $('.update-send').css("background", "rgba(27,108,168,1)");
                            $('.update-send').css("border", "1px solid rgba(27,108,168,1)");
                            $('.update-send').css("color", "#fff");
                            $(".update-send").val("重新发送");
                        }
                    }, 1000);
                    layer.msg(res.msg);
                } else {
                    layer.msg(res.msg);
                }
            }, error: function () {
                layer.msg('系统错误,请稍后重试');
            }
        });
    }
}

//登录
function getLogin() {
    var phone = $(".login-phone").val(); //手机号码
    var code = $(".login-code").val(); //验证码
    var reg = /^1[3|4|5|7|8][0-9]\d{4,8}$/;
    var path = window.location.pathname;
    if (!reg.exec(phone) || phone == null || phone == '') {
        layer.msg("手机号输入错误");
        return false;
    }
    if (!code) {
        layer.msg("请输入验证码");
        return false;
    }
    $.ajax({
        type: 'post',
        data: {'code': code, 'phone': phone},
        url: '/login',
        dataType: 'json',
        async: false,
        success: function (res) {
            if (res.code == 200) {
                layer.msg(res.msg, {time: 2000}, function () {
                    window.location.href = '/';
                });
            } else {
                layer.msg(res.msg);
            }
        }, error: function () {
            layer.msg('系统错误,请稍后重试');
        }
    });
}

//密码登录
function passLogin() {
    var phone = $(".pass-login-phone").val(); //手机号码
    var pass = $(".pass-login-pass").val(); //密码
    var code = $(".login-code").val(); //验证码
    var reg = /^1[3|4|5|7|8][0-9]\d{4,8}$/;
    if (!reg.exec(phone) || phone == null || phone == '') {
        layer.msg("手机号输入错误");
        return false;
    }
    if (!pass) {
        layer.msg("请输入密码");
        return false;
    }
    if (!code) {
        layer.msg("请输入验证码");
        return false;
    }
    $.ajax({
        type: 'post',
        data: {'pass': pass, 'phone': phone, 'code': code},
        url: '/passLogin',
        dataType: 'json',
        async: false,
        success: function (res) {
            if (res.code == 200) {
                layer.msg(res.msg, {time: 2000}, function () {
                    window.location.href = '/';
                });
            } else {
                layer.msg(res.msg);
            }
        }, error: function () {
            layer.msg('系统错误,请稍后重试');
        }
    });
}

//退出登录
function logout() {
    $.ajax({
        type: 'post',
        data: {},
        url: '/logout',
        dataType: 'json',
        async: false,
        success: function (res) {
            if (res.code == 200) {
                layer.msg(res.msg, {time: 2000}, function () {
                    window.location.reload();
                });
            }
        }, error: function () {
            layer.msg('系统错误,请稍后重试');
        }
    });
    return false;
}